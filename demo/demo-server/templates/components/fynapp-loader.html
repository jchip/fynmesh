<!-- Load core scripts -->
{% if isProduction %}
<script src="{{pathPrefix}}system.min.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.min.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.min.js"></script>
{% else %}
<script src="{{pathPrefix}}system.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.dev.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.dev.js"></script>
{% endif %}

<script>
  (function() {
    // Configure service worker base path
    window.SW_BASE_PATH = '{{pathPrefix}}';

    // Load service worker utils
    const script = document.createElement('script');
    script.src = '{{pathPrefix}}sw-utils.js';
    document.head.appendChild(script);
  })();
</script>
<script>
    (async () => {
        // Configure kernel manifest resolver with path prefix (demo only)
        if (typeof fynMeshKernel?.setRegistryResolver === "function") {
            const prefix = "{{pathPrefix}}";

            // Version-aware package mapping: package@range -> directory
            const versionMapping = {
                "fynapp-x1": {
                    "^1.0.0": "fynapp-x1-v1",
                    "^2.0.0": "fynapp-x1-v2",
                    "default": "fynapp-x1-v2"  // Default to v2 if no version specified
                },
                "fynapp-react-lib": {
                    "^18.0.0": "fynapp-react-18",
                    "^19.0.0": "fynapp-react-19",
                    "default": "fynapp-react-19"  // Default to React 19
                },
                "esm-react": {
                    "^18.0.0": "fynapp-react-18",
                    "^18.3.0": "fynapp-react-18",
                    "^19.0.0": "fynapp-react-19",
                    "default": "fynapp-react-19"  // Default to React 19
                }
            };

            fynMeshKernel.setRegistryResolver(async (name, range) => {
                let dirName = name;  // Default to the package name

                // Check if we have version-specific mappings for this package
                const mappings = versionMapping[name];
                if (mappings) {
                    if (range && mappings[range]) {
                        // Use version-specific mapping if available
                        dirName = mappings[range];
                    } else if (mappings.default) {
                        // Use default mapping if no version specified or no match
                        dirName = mappings.default;
                    }
                }

                // Extract version from directory name (e.g., "fynapp-x1-v2" -> "2.0.0", "fynapp-react-18" -> "18.0.0")
                // This ensures unique keys in the dependency graph
                let version = "0.0.0";
                const versionMatch = dirName.match(/-v?(\d+)$/);
                if (versionMatch) {
                    version = `${versionMatch[1]}.0.0`;
                }

                return {
                    name,
                    version,
                    manifestUrl: `${prefix}${dirName}/dist/fynapp.manifest.json`,
                    distBase: `${prefix}${dirName}/dist/`,
                };
            });
        }

        // STEP 1: All React providers now automatically loaded via shared-providers
        // No explicit pre-loading needed - kernel automatically detects and loads providers
        // based on consumer manifests' shared-providers declarations

        // STEP 2: Load consumer FynApps - kernel will automatically resolve dependencies
        // including middleware providers and component libraries from manifests
        console.log("DEBUG: Starting automatic dependency resolution");

        // Feature flags to control which FynApps to load
        const features = {
            "fynapp-2-react18": true,
            "fynapp-1": true,
            "fynapp-1-b": true,
            "fynapp-3-marko": true,
            "fynapp-4-vue": true,
            "fynapp-5-preact": true,
            "fynapp-6-react": true,
            "fynapp-7-solid": true
        };

        // Add all consumer FynApps - kernel will analyze their import-exposed dependencies
        // and automatically load any required middleware providers or component libraries
        const requested = [];
        if (features["fynapp-2-react18"]) requested.push({ name: "fynapp-2-react18" });
        if (features["fynapp-1"]) requested.push({ name: "fynapp-1" });
        if (features["fynapp-1-b"]) requested.push({ name: "fynapp-1-b" });
        if (features["fynapp-3-marko"]) requested.push({ name: "fynapp-3-marko" });
        if (features["fynapp-4-vue"]) requested.push({ name: "fynapp-4-vue" });
        if (features["fynapp-5-preact"]) requested.push({ name: "fynapp-5-preact" });
        if (features["fynapp-6-react"]) requested.push({ name: "fynapp-6-react" });
        if (features["fynapp-7-solid"]) requested.push({ name: "fynapp-7-solid" });

        if (requested.length > 0) {
            await fynMeshKernel.loadFynAppsByName(requested, { concurrency: 4 });
        }
    })();
</script>
