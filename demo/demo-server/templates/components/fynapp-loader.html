<!-- Load core scripts -->
{% if isProduction %}
<script src="{{pathPrefix}}system.min.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.min.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.min.js"></script>
{% else %}
<script src="{{pathPrefix}}system.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.dev.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.dev.js"></script>
{% endif %}

<!-- Lazy Loader for deferred app loading -->
<script src="{{pathPrefix}}lazy-loader.js"></script>

<script>
  (function() {
    // Configure service worker base path
    window.SW_BASE_PATH = '{{pathPrefix}}';

    // Load service worker utils
    const script = document.createElement('script');
    script.src = '{{pathPrefix}}sw-utils.js';
    document.head.appendChild(script);
  })();
</script>
<script>
    (async () => {
        // Configure kernel manifest resolver with path prefix (demo only)
        if (typeof fynMeshKernel?.setRegistryResolver === "function") {
            const prefix = "{{pathPrefix}}";

            // Version-aware package mapping: package@range -> directory
            const versionMapping = {
                "fynapp-x1": {
                    "^1.0.0": "fynapp-x1-v1",
                    "^2.0.0": "fynapp-x1-v2",
                    "default": "fynapp-x1-v2"  // Default to v2 if no version specified
                },
                "fynapp-react-lib": {
                    "^18.0.0": "fynapp-react-18",
                    "^19.0.0": "fynapp-react-19",
                    "default": "fynapp-react-19"  // Default to React 19
                },
                "esm-react": {
                    "^18.0.0": "fynapp-react-18",
                    "^18.3.0": "fynapp-react-18",
                    "^19.0.0": "fynapp-react-19",
                    "default": "fynapp-react-19"  // Default to React 19
                }
            };

            fynMeshKernel.setRegistryResolver(async (name, range) => {
                let dirName = name;  // Default to the package name

                // Check if we have version-specific mappings for this package
                const mappings = versionMapping[name];
                if (mappings) {
                    if (range && mappings[range]) {
                        // Use version-specific mapping if available
                        dirName = mappings[range];
                    } else if (mappings.default) {
                        // Use default mapping if no version specified or no match
                        dirName = mappings.default;
                    }
                }

                // Extract version from directory name (e.g., "fynapp-x1-v2" -> "2.0.0", "fynapp-react-18" -> "18.0.0")
                // This ensures unique keys in the dependency graph
                let version = "0.0.0";
                const versionMatch = dirName.match(/-v?(\d+)$/);
                if (versionMatch) {
                    version = `${versionMatch[1]}.0.0`;
                }

                return {
                    name,
                    version,
                    manifestUrl: `${prefix}${dirName}/dist/fynapp.manifest.json`,
                    distBase: `${prefix}${dirName}/dist/`,
                };
            });
        }

        // STEP 1: All React providers now automatically loaded via shared-providers
        // No explicit pre-loading needed - kernel automatically detects and loads providers
        // based on consumer manifests' shared-providers declarations

        // STEP 2: Load consumer FynApps - kernel will automatically resolve dependencies
        // including middleware providers and component libraries from manifests
        console.log("DEBUG: Starting automatic dependency resolution");

        // Feature flags to control which FynApps to load
        // Values: true = eager load, "lazy" = deferred load with UI
        const features = {
            "fynapp-2-react18": "lazy",  // Deferred loading with button and countdown
            "fynapp-1": true,
            "fynapp-1-b": true,
            "fynapp-3-marko": true,
            "fynapp-4-vue": true,
            "fynapp-5-preact": true,
            "fynapp-6-react": true,
            "fynapp-7-solid": true,
            "fynapp-8-svelte": true
        };

        // Separate eager and lazy apps
        const requested = [];
        const lazyApps = [];

        Object.entries(features).forEach(([name, mode]) => {
            if (mode === "lazy") {
                lazyApps.push({ name, mode: "lazy" });
            } else if (mode === true) {
                requested.push({ name });
            }
        });

        // Load eager apps first
        if (requested.length > 0) {
            await fynMeshKernel.loadFynAppsByName(requested, { concurrency: 4 });
        }

        // Initialize lazy loaders after eager apps complete
        lazyApps.forEach(({ name }) => {
            console.debug(`ðŸ”„ Initializing lazy loader for ${name}`);
            const loader = new LazyLoader(name, "FynApp 2", fynMeshKernel, { countdown: 10 });
            loader.init();
        });
    })();
</script>
