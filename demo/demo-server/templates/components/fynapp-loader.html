<!-- Load core scripts -->
{% if isProduction %}
<script src="{{pathPrefix}}system.min.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.min.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.min.js"></script>
{% else %}
<script src="{{pathPrefix}}system.js"></script>
<script src="{{pathPrefix}}federation-js/dist/federation-js.dev.js"></script>
<script src="{{pathPrefix}}kernel/dist/fynmesh-browser-kernel.dev.js"></script>
{% endif %}

<script>
  (function() {
    // Configure service worker base path
    window.SW_BASE_PATH = '{{pathPrefix}}';
    
    // Load service worker utils
    const script = document.createElement('script');
    script.src = '{{pathPrefix}}sw-utils.js';
    script.onload = () => {
      // Signal that core scripts are loaded
      window.FYNMESH_CORE_LOADED = true;
      window.dispatchEvent(new Event('fynmesh-core-loaded'));
    };
    document.head.appendChild(script);
  })();
</script>
<script>
    // Wait for core scripts to load before initializing FynApps
    (async () => {
        // Wait for core scripts if not already loaded
        if (!window.FYNMESH_CORE_LOADED) {
            await new Promise(resolve => {
                window.addEventListener('fynmesh-core-loaded', resolve, { once: true });
            });
        }
        
        const features = {
            "react-18": {{ features["react-18"] | default(true) | dump | safe }},
            "react-19": {{ features["react-19"] | default(true) | dump | safe }},
            "fynapp-1": {{ features["fynapp-1"] | default(true) | dump | safe }},
            "fynapp-1-b": {{ features["fynapp-1-b"] | default(true) | dump | safe }},
            "fynapp-2-react18": {{ features["fynapp-2-react18"] | default(true) | dump | safe }},
            "fynapp-3-marko": {{ features["fynapp-3-marko"] | default(true) | dump | safe }},
            "fynapp-4-vue": {{ features["fynapp-4-vue"] | default(true) | dump | safe }},
            "fynapp-5-preact": {{ features["fynapp-5-preact"] | default(true) | dump | safe }},
            "fynapp-6-react": {{ features["fynapp-6-react"] | default(true) | dump | safe }},
            "fynapp-7-solid": {{ features["fynapp-7-solid"] | default(true) | dump | safe }},
            "fynapp-x1-v1": {{ features["fynapp-x1-v1"] | default(true) | dump | safe }},
            "fynapp-x1-v2": {{ features["fynapp-x1-v2"] | default(true) | dump | safe }},
            "fynapp-react-middleware": {{ features["fynapp-react-middleware"] | default(true) | dump | safe }},
            "design-tokens": {{ features["design-tokens"] | default(true) | dump | safe }}
        };

        // Configure kernel manifest resolver with path prefix (demo only)
        if (typeof fynMeshKernel?.setRegistryResolver === "function") {
            const prefix = "{{pathPrefix}}";
            fynMeshKernel.setRegistryResolver(async (name) => ({
                name,
                version: "0.0.0",
                manifestUrl: `${prefix}${name}/dist/fynapp.manifest.json`,
                distBase: `${prefix}${name}/dist/`,
            }));
        }

        // STEP 1: Load react versions (shared dependencies)
        if (features["react-18"]) {
            fynMeshKernel.loadFynApp("{{pathPrefix}}fynapp-react-18/dist");
            console.log("loading remote fynapp {{pathPrefix}}fynapp-react-18/dist");
        }
        // load react 19
        if (features["react-19"]) {
            fynMeshKernel.loadFynApp("{{pathPrefix}}fynapp-react-19/dist");
            console.log("loading remote fynapp {{pathPrefix}}fynapp-react-19/dist");
        }

        // STEP 2: Load consumer FynApps with full dependency resolution (includes middleware providers automatically)
        console.log("DEBUG: STEP 2 - Starting full dependency-planned loading with middleware providers");

        const requested = [];
        // Add middleware providers first
        if (features["design-tokens"]) requested.push({ name: "fynapp-design-tokens" });
        if (features["fynapp-react-middleware"]) requested.push({ name: "fynapp-react-middleware" });

        // Add component libraries that use middleware
        if (features["fynapp-x1-v2"]) requested.push({ name: "fynapp-x1-v2" });
        if (features["fynapp-x1-v1"]) requested.push({ name: "fynapp-x1-v1" });

        // Add consumer FynApps (will automatically resolve their dependencies)
        if (features["fynapp-2-react18"]) requested.push({ name: "fynapp-2-react18" });
        if (features["fynapp-1"]) requested.push({ name: "fynapp-1" });
        if (features["fynapp-1-b"]) requested.push({ name: "fynapp-1-b" });
        if (features["fynapp-3-marko"]) requested.push({ name: "fynapp-3-marko" });
        if (features["fynapp-4-vue"]) requested.push({ name: "fynapp-4-vue" });
        if (features["fynapp-5-preact"]) requested.push({ name: "fynapp-5-preact" });
        if (features["fynapp-6-react"]) requested.push({ name: "fynapp-6-react" });
        if (features["fynapp-7-solid"]) requested.push({ name: "fynapp-7-solid" });

        if (requested.length > 0) {
            await fynMeshKernel.loadFynAppsByName(requested, { concurrency: 4 });
        }
    })();
</script>
