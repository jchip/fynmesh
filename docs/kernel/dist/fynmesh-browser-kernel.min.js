!function(){"use strict";class e extends EventTarget{constructor(){super()}on(e,t,r){this.addEventListener(e,t,r)}once(e,t,r){const s=r=>(this.removeEventListener(e,s),function(e){return"function"==typeof e}(t)?t(r):t.handleEvent(r));this.addEventListener(e,s,r)}}class t{constructor(){this.manifestCache=new Map,this.nodeMeta=new Map,this.preloadedEntries=new Map}setRegistryResolver(e){this.registryResolver=e}setPreloadCallback(e){this.preloadCallback=e}preloadEntryFile(e,t,r){const s=`${t}fynapp-entry.js`;this.preloadedEntries.has(s)||(this.preloadedEntries.set(s,r),this.preloadCallback&&this.preloadCallback(s,r))}getNodeMeta(e){return this.nodeMeta.get(e)}getAllNodeMeta(){return this.nodeMeta}clearCache(){this.manifestCache.clear(),this.nodeMeta.clear(),this.preloadedEntries.clear()}async fetchJson(e){const t=await fetch(e,{credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP ${t.status} for ${e}`);return t.json()}calculateDistBase(e){return e.distBase||new URL(e.manifestUrl,location.href).pathname.replace(/\/[^/]*$/,"/")}updateNodeMeta(e,t,r){const s=this.calculateDistBase(t),a=r.version||t.version;this.nodeMeta.set(e,{name:t.name,version:a,manifestUrl:t.manifestUrl,distBase:s})}async resolveAndFetch(e,t){if(!this.registryResolver)throw new Error("No registry resolver configured");const r=await this.registryResolver(e,t),s=r.version,a=`${r.name}@${s}`,i=this.manifestCache.get(a);if(i)return this.updateNodeMeta(a,{...r,version:s},i),{key:a,res:r,manifest:i};let n;try{const e=globalThis.Federation;if(e){const t=r.manifestUrl.replace(/fynapp\.manifest\.json$/,"fynapp-entry.js"),s=await e.import(t);if(s&&s.__FYNAPP_MANIFEST__){n=s.__FYNAPP_MANIFEST__;const e=`${r.name}@${n.version||r.version}`;return this.manifestCache.set(e,n),this.updateNodeMeta(e,r,n),{key:e,res:r,manifest:n}}}}catch(e){}try{n=await this.fetchJson(r.manifestUrl)}catch(t){try{const e=r.manifestUrl.replace(/fynapp\.manifest\.json$/,"federation.json");n=await this.fetchJson(e)}catch(t){n={name:e,version:r.version,requires:[]}}}const o=`${r.name}@${n.version||r.version}`;return this.manifestCache.set(o,n),this.updateNodeMeta(o,r,n),{key:o,res:r,manifest:n}}async buildGraph(e){const t=new Map,r=new Map,s=new Set,a=async(e,i,n,o=0)=>{const{key:d,manifest:l}=await this.resolveAndFetch(e,i),p=!s.has(d);if(p&&(s.add(d),r.set(d,r.get(d)??0)),n){const e=t.get(d)||new Set;e.has(n)||(e.add(n),t.set(d,e),r.set(n,(r.get(n)??0)+1))}if(!p)return d;const c=l.requires||[];for(const e of c){const t=await this.registryResolver(e.name,e.range),r=this.calculateDistBase(t);this.preloadEntryFile(e.name,r,o+1),await a(e.name,e.range,d,o+1)}const h=l["import-exposed"];if(h&&"object"==typeof h)for(const[e,t]of Object.entries(h)){let r;if(t&&"object"==typeof t)for(const e of Object.values(t))if(e&&"object"==typeof e&&"semver"in e){r=e.semver;break}const s=await this.registryResolver(e,r),i=this.calculateDistBase(s);this.preloadEntryFile(e,i,o+1),await a(e,r,d,o+1)}const u=l["shared-providers"];if(u&&"object"==typeof u)for(const[e,t]of Object.entries(u)){let r;t&&"object"==typeof t&&"semver"in t&&(r=t.semver);const s=await this.registryResolver(e,r),i=this.calculateDistBase(s);this.preloadEntryFile(e,i,o+1),await a(e,r,d,o+1)}return d};for(const t of e)await a(t.name,t.range);return{nodes:s,adj:t,indegree:r}}topoBatches(e){const{nodes:t,adj:r}=e,s=new Map(e.indegree),a=[];for(const e of t)0===(s.get(e)??0)&&a.push(e);const i=[],n=[];for(;a.length;){const e=a.splice(0,a.length);n.push(e);for(const t of e){i.push(t);for(const e of r.get(t)??[])s.set(e,(s.get(e)??0)-1),0===(s.get(e)??0)&&a.push(e)}}if(i.length<t.size){const e=[...t].filter(e=>(s.get(e)??0)>0);console.warn(`‚ö†Ô∏è Dependency cycle detected among: ${e.join(", ")} - proceeding with best-effort loading`),n.push(e)}return n}}class r{constructor(e,t){this.bootstrappingApp=null,this.deferredBootstraps=[],this.fynAppBootstrapStatus=new Map,this.fynAppProviderModes=new Map,this.timeout=3e4,this.events=e,void 0!==t&&(this.timeout=t),this.events.on("FYNAPP_BOOTSTRAPPED",e=>{this.handleFynAppBootstrapped(e)})}setTimeout(e){this.timeout=e}getTimeout(){return this.timeout}getBootstrapState(){return{bootstrappingApp:this.bootstrappingApp,deferredBootstraps:[...this.deferredBootstraps],fynAppBootstrapStatus:new Map(this.fynAppBootstrapStatus),fynAppProviderModes:new Map(this.fynAppProviderModes)}}canBootstrap(e){return null===this.bootstrappingApp&&this.areBootstrapDependenciesSatisfied(e)}acquireBootstrapLock(e){return null===this.bootstrappingApp&&(this.bootstrappingApp=e,!0)}releaseBootstrapLock(){this.bootstrappingApp=null}deferBootstrap(e){const t=null!==this.bootstrappingApp?`${this.bootstrappingApp} is currently bootstrapping`:"waiting for provider dependencies";return new Promise((r,s)=>{const a={fynApp:e,resolve:()=>{a.timeoutId&&clearTimeout(a.timeoutId),r()}};a.timeoutId=setTimeout(()=>{const s=this.deferredBootstraps.indexOf(a);s>=0&&this.deferredBootstraps.splice(s,1),console.error(`‚è∞ Bootstrap timeout (${this.timeout}ms): ${e.name} timed out waiting for ${t}. Skipping this FynApp - the party goes on!`),this.events.dispatchEvent(new CustomEvent("FYNAPP_BOOTSTRAP_TIMEOUT",{detail:{name:e.name,version:e.version,reason:t,timeout:this.timeout}})),r()},this.timeout),this.deferredBootstraps.push(a)})}markBootstrapped(e){this.fynAppBootstrapStatus.set(e,"bootstrapped")}registerProviderMode(e,t,r){this.fynAppProviderModes.has(e)||this.fynAppProviderModes.set(e,new Map),this.fynAppProviderModes.get(e).set(t,r)}async handleFynAppBootstrapped(e){const{name:t}=e.detail;this.markBootstrapped(t),this.releaseBootstrapLock();let r=-1;for(let e=0;e<this.deferredBootstraps.length;e++){const t=this.deferredBootstraps[e];if(this.areBootstrapDependenciesSatisfied(t.fynApp)){r=e;break}}r>=0?this.deferredBootstraps.splice(r,1)[0].resolve():this.deferredBootstraps.length}areBootstrapDependenciesSatisfied(e){const t=this.fynAppProviderModes.get(e.name);if(!t)return!0;for(const[r,s]of t.entries())if("consumer"===s){const t=this.findProviderForMiddleware(r,e.name);if(t&&!this.fynAppBootstrapStatus.has(t))return!1}return!0}findProviderForMiddleware(e,t){for(const[r,s]of this.fynAppProviderModes.entries())if(r!==t&&"provider"===s.get(e))return r;return null}clear(){this.bootstrappingApp=null;for(const e of this.deferredBootstraps)e.timeoutId&&clearTimeout(e.timeoutId);this.deferredBootstraps=[],this.fynAppBootstrapStatus.clear(),this.fynAppProviderModes.clear()}}const s={regKey:""};class a{constructor(){this.middlewares={},this.scannedModules=new Set}registerMiddleware(e){const{regKey:t,hostFynApp:r}=e,s=this.middlewares[t]||Object.create(null);if(s[r.version])return;s[r.version]=e,s.default||(s.default=e),this.middlewares[t]=s;const a=e.middleware.autoApplyScope||[];a.length>0&&(this.autoApplyMiddlewares||(this.autoApplyMiddlewares={fynapp:[],middleware:[]}),(a.includes("all")||a.includes("fynapp"))&&this.autoApplyMiddlewares.fynapp.push(e),(a.includes("all")||a.includes("middleware"))&&this.autoApplyMiddlewares.middleware.push(e))}getMiddleware(e,t){if(t){const r=`${t}::${e}`,s=this.middlewares[r];if(s){const e=s.default;if(e)return e}}for(const[t,r]of Object.entries(this.middlewares))if(t.endsWith(`::${e}`)){const e=r.default;if(e)return e}return s}getAutoApplyMiddlewares(){return this.autoApplyMiddlewares}getTargetMiddlewares(e){return this.autoApplyMiddlewares?e?this.autoApplyMiddlewares.middleware:this.autoApplyMiddlewares.fynapp:[]}hasScannedModule(e){return this.scannedModules.has(e)}markModuleScanned(e){this.scannedModules.add(e)}scanAndRegisterMiddleware(e,t,r){const s=`${e.name}@${e.version}::${t}`;if(this.hasScannedModule(s))return[];this.markModuleScanned(s);const a=[];for(const[s,i]of Object.entries(r))if(s.startsWith("__middleware__")){const r=i,n=r.name,o={regKey:`${e.name}::${n}`,fullKey:`${e.name}@${e.version}::${n}`,hostFynApp:e,exposeName:t,exportName:s,middleware:r};this.registerMiddleware(o),a.push(s)}return a}initializeFromRuntime(e){e.middlewares&&(this.middlewares=e.middlewares),e.autoApplyMiddlewares&&(this.autoApplyMiddlewares=e.autoApplyMiddlewares)}exportToRuntime(){return{middlewares:this.middlewares,autoApplyMiddlewares:this.autoApplyMiddlewares}}clear(){this.middlewares={},this.autoApplyMiddlewares=void 0,this.scannedModules.clear()}}var i,n;!function(e){e[e.MODULE_NOT_FOUND=1001]="MODULE_NOT_FOUND",e[e.MODULE_LOAD_FAILED=1002]="MODULE_LOAD_FAILED",e[e.EXPOSE_MODULE_NOT_FOUND=1003]="EXPOSE_MODULE_NOT_FOUND",e[e.DEPENDENCY_NOT_FOUND=1004]="DEPENDENCY_NOT_FOUND",e[e.MIDDLEWARE_NOT_FOUND=2001]="MIDDLEWARE_NOT_FOUND",e[e.MIDDLEWARE_SETUP_FAILED=2002]="MIDDLEWARE_SETUP_FAILED",e[e.MIDDLEWARE_APPLY_FAILED=2003]="MIDDLEWARE_APPLY_FAILED",e[e.MIDDLEWARE_FILTER_ERROR=2004]="MIDDLEWARE_FILTER_ERROR",e[e.BOOTSTRAP_FAILED=3001]="BOOTSTRAP_FAILED",e[e.REGISTRY_RESOLVER_MISSING=3002]="REGISTRY_RESOLVER_MISSING",e[e.MANIFEST_FETCH_FAILED=4001]="MANIFEST_FETCH_FAILED",e[e.MANIFEST_PARSE_FAILED=4002]="MANIFEST_PARSE_FAILED",e[e.FEDERATION_NOT_LOADED=5001]="FEDERATION_NOT_LOADED",e[e.FEDERATION_ENTRY_FAILED=5002]="FEDERATION_ENTRY_FAILED"}(i||(i={}));class o extends Error{constructor(e,t,r){super(t),this.name="KernelError",this.code=e,this.context=r?.context,this.cause=r?.cause,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toDetailedString(){let e=`[${this.name}:${this.code}] ${this.message}`;return this.context&&(e+=`\nContext: ${JSON.stringify(this.context,null,2)}`),this.cause&&(e+=`\nCaused by: ${this.cause.message}`),e}}class d extends o{constructor(e,t,r){super(e,t,{context:{fynAppName:r?.fynAppName,fynAppVersion:r?.fynAppVersion,exposeName:r?.exposeName},cause:r?.cause}),this.name="ModuleLoadError"}}class l extends o{constructor(e,t,r){super(e,t,{context:{middlewareName:r?.middlewareName,provider:r?.provider,fynAppName:r?.fynAppName},cause:r?.cause}),this.name="MiddlewareError"}}function p(e){return{success:!0,value:e}}function c(e){return{success:!1,error:e}}class h{constructor(){this.scannedModules=new Set}async loadExposeModule(e,t,r,s){const a=e.entry.container;if(!a?.$E[t])return c(new d(i.EXPOSE_MODULE_NOT_FOUND,`No expose module '${t}' found for ${e.name}@${e.version}`,{fynAppName:e.name,fynAppVersion:e.version,exposeName:t}));const n=await e.entry.get(t),o="function"==typeof n?n():void 0,l=[],h=`${e.name}@${e.version}::${t}`;if(r&&o&&"object"==typeof o){if(!this.scannedModules.has(h)){this.scannedModules.add(h);for(const[r,a]of Object.entries(o))if(r.startsWith("__middleware__")){const i=a,n=i.name,o={regKey:`${e.name}::${n}`,fullKey:`${e.name}@${e.version}::${n}`,hostFynApp:e,exposeName:t,exportName:r,middleware:i};s&&s(o),l.push(r)}}return e.exposes[t]=o,o.__name&&(e.exposes[o.__name]=o),p(o)}return p(o)}async loadMiddlewareFromDependency(e,t,r,s){const a=r[e];if(!a)return c(new d(i.DEPENDENCY_NOT_FOUND,`Dependency package ${e} not found in runtime`,{fynAppName:e,exposeName:t}));const n=t.lastIndexOf("/"),o=`./${n>0?t.substring(0,n):t}`,l=await this.loadExposeModule(a,o,!0,s);return l.success?p(void 0):c(l.error)}async loadFynAppBasics(e,t,r){const s=e.container;e.init();const a={name:s.name,version:s.version||"1.0.0",packageName:s.name,entry:e,middlewareContext:new Map,exposes:{}};if(s&&s.$E["./config"]){const t=await e.get("./config");a.config=t()}e.setup&&await e.setup(),(await this.loadExposeModule(a,"./main",!0,r)).success;const i=s.__FYNAPP_MANIFEST__||null,n=i?.["import-exposed"];if(n&&"object"==typeof n){const e=[];for(const[s,a]of Object.entries(n))if(a&&"object"==typeof a)for(const[i,n]of Object.entries(a))if(n&&"object"==typeof n&&"middleware"===n.type){const a=await this.loadMiddlewareFromDependency(s,i,t,r);a.success||e.push(a.error)}e.length}return t[a.name]=a,a}createFynUnitRuntime(e){return{fynApp:e,middlewareContext:new Map}}createFynModuleRuntime(e){return this.createFynUnitRuntime(e)}findExecutionOverride(e,t,r){if(!r)return null;const s=Object.keys(e.exposes).some(e=>e.startsWith("./middleware"))?r.middleware:r.fynapp;for(const r of s)if(r.middleware.canOverrideExecution?.(e,t))return r;return null}async invokeFynUnit(e,t,r){const s=this.createFynUnitRuntime(t),a=this.findExecutionOverride(t,e,r);if(a){const r={meta:{info:{name:a.middleware.name,provider:a.hostFynApp.name,version:a.hostFynApp.version},config:{}},fynUnit:e,fynMod:e,fynApp:t,reg:a,runtime:s,kernel:null,status:"ready"};return a.middleware.overrideInitialize&&e.initialize&&await a.middleware.overrideInitialize(r),void(a.middleware.overrideExecute&&"function"==typeof e.execute&&await a.middleware.overrideExecute(r))}e.initialize&&await e.initialize(s),e.execute&&await e.execute(s)}async invokeFynModule(e,t,r){return this.invokeFynUnit(e,t,r)}clear(){this.scannedModules.clear()}}class u{constructor(){this.middlewareReady=new Map,this.deferInvoke=[]}setMiddlewareReady(e,t){this.middlewareReady.set(e,t)}findExecutionOverride(e,t,r){if(!r)return null;const s=Object.keys(e.exposes).some(e=>e.startsWith("./middleware"))?r.middleware:r.fynapp;for(const r of s)if(r.middleware.canOverrideExecution?.(e,t))return r;return null}checkSingleMiddlewareReady(e){return!!this.middlewareReady.has(e.reg.fullKey)&&(e.runtime.share=this.middlewareReady.get(e.reg.fullKey),e.status="ready",!0)}checkMiddlewareReady(e){let t="ready";for(const r of e)this.checkSingleMiddlewareReady(r)||(t="defer");return t}checkDeferCalls(e,t){if("defer"===e){if("ready"===this.checkMiddlewareReady(t))return"retry";const e=t.map(e=>e.reg.fullKey).sort().join("|");return this.deferInvoke.some(t=>t.callContexts.map(e=>e.reg.fullKey).sort().join("|")===e)||this.deferInvoke.push({callContexts:t}),"defer"}return"ready"}processReadyMiddleware(e,t){this.setMiddlewareReady(e,t);const r=[];for(let s=0;s<this.deferInvoke.length;s++){const{callContexts:a}=this.deferInvoke[s];let i=!0;for(const r of a)r.reg.fullKey===e&&(r.runtime.share=t,r.status="ready"),"ready"!==r.status&&"skip"!==r.status&&(i=!1);i&&r.push(s)}const s=[];if(r.length>0){for(let e=r.length-1;e>=0;e--){const t=r[e];s.push(this.deferInvoke[t]),this.deferInvoke.splice(t,1)}s.reverse()}return{resumes:s}}async callMiddlewares(e,t,r,s,a=0){if(0===e.length)return"ready";if(a>1){const t=new l(i.MIDDLEWARE_SETUP_FAILED,`Middleware setup failed after 2 tries for ${e.map(e=>e.reg.regKey).join(", ")}`,{middlewareName:e[0]?.reg.middleware.name,provider:e[0]?.reg.hostFynApp.name,fynAppName:e[0]?.fynApp.name});throw console.error(`üö® ${t.message}`),t}this.checkMiddlewareReady(e);let n="ready";for(const r of e){const{fynApp:e,reg:s}=r,a=s.middleware;if(this.checkSingleMiddlewareReady(r),a.setup){const e=await a.setup(r);"ready"!==e?.status||this.middlewareReady.has(r.reg.fullKey)||t&&await t(r,e?.share),"defer"===e?.status&&(n="defer")}}if(n=this.checkDeferCalls(n,e),"defer"===n)return n;if("retry"===n)return await this.callMiddlewares(e,t,r,s,a+1);const o=e[0].fynUnit,d=e[0].fynApp,p=e[0].runtime;if(o.initialize){const i=await o.initialize(p);if(i?.mode&&r)for(const t of e)r(d.name,t.reg.middleware.name,i.mode);if(n=this.checkDeferCalls(i?.status,e),"defer"===n&&!i?.deferOk)return"defer";if("retry"===n)return await this.callMiddlewares(e,t,r,s,a+1)}for(const t of e){const{reg:e}=t,r=e.middleware;r.apply&&await r.apply(t)}const c=this.findExecutionOverride(d,o,s);if(c){const t={meta:{info:{name:c.middleware.name,provider:c.hostFynApp.name,version:c.hostFynApp.version},config:{}},fynUnit:o,fynMod:o,fynApp:d,reg:c,runtime:p,kernel:e[0].kernel,status:"ready"};c.middleware.overrideInitialize&&o.initialize&&await c.middleware.overrideInitialize(t),c.middleware.overrideExecute&&"function"==typeof o.execute&&await c.middleware.overrideExecute(t)}else o.execute&&await o.execute(p);return"ready"}async parseMiddlewareString(e,t,r,s,a,i,n,o){const d=e.trim().split(" ");if(d.length<3||"-FYNAPP_MIDDLEWARE"!==d[0])return null;const[,l,p,c]=d,h=p.split("/").pop()||p;o&&await o(l,p);const u=n(h,l);return""===u.regKey?null:{meta:{info:{name:h,provider:l,version:c||"*"},config:t||{}},fynUnit:r,fynMod:r,fynApp:s,reg:u,kernel:a,runtime:i,status:""}}async useMiddlewareOnFynUnit(e,t,r,s,a,i,n){if(!e.__middlewareMeta)return"";const o=s(),d=[];for(const s of e.__middlewareMeta){let n=null;if("string"==typeof s)n=await this.parseMiddlewareString(s,{},e,t,r,o,a,i);else if(s&&"object"==typeof s)if(s.middleware&&"string"==typeof s.middleware)n=await this.parseMiddlewareString(s.middleware,s.config||{},e,t,r,o,a,i);else if(s.info){const i=s.info,d=a(i.name,i.provider);if(""===d.regKey)continue;n={meta:s,fynUnit:e,fynMod:e,fynApp:t,reg:d,kernel:r,runtime:o,status:""}}n&&d.push(n)}return this.callMiddlewares(d,void 0,void 0,n)}async useMiddlewareOnFynModule(e,t,r,s,a,i,n){return this.useMiddlewareOnFynUnit(e,t,r,s,a,i,n)}async applyAutoScopeMiddlewares(e,t,r,s,a,n){const o=[];if(!s)return o;const d=function(e){return Object.keys(e.exposes).some(e=>e.startsWith("./middleware"))}(e)?s.middleware:s.fynapp;for(const s of d){if(s.middleware.shouldApply)try{if(!s.middleware.shouldApply(e))continue}catch(t){const r=new l(i.MIDDLEWARE_FILTER_ERROR,`Error in shouldApply for ${s.regKey}: ${t instanceof Error?t.message:String(t)}`,{middlewareName:s.middleware.name,provider:s.hostFynApp.name,fynAppName:e.name,cause:t instanceof Error?t:void 0});console.error(`‚ùå ${r.message}`),o.push(r);continue}const d=t||{async execute(){}},p={meta:{info:{name:s.middleware.name,provider:s.hostFynApp.name,version:s.hostFynApp.version},config:{}},fynUnit:d,fynMod:d,fynApp:e,reg:s,runtime:a(),kernel:r,status:"ready"};try{if(s.middleware.setup){const e=await s.middleware.setup(p);"ready"===e?.status&&n&&await n(p,e.share)}s.middleware.apply&&await s.middleware.apply(p)}catch(t){const r=new l(i.MIDDLEWARE_APPLY_FAILED,`Failed to apply auto-scope middleware ${s.regKey} to ${e.name}: ${t instanceof Error?t.message:String(t)}`,{middlewareName:s.middleware.name,provider:s.hostFynApp.name,fynAppName:e.name,cause:t instanceof Error?t:void 0});console.error(`‚ùå ${r.message}`),o.push(r)}}return o}clear(){this.middlewareReady.clear(),this.deferInvoke=[]}getDeferredInvokes(){return[...this.deferInvoke]}getReadyMiddleware(){return new Map(this.middlewareReady)}}class f{constructor(){this.version="1.0.0",this.shareScopeName="fynmesh",this.events=new e,this.runTime={appsLoaded:{},middlewares:{}},this.manifestResolver=new t,this.bootstrapCoordinator=new r(this.events),this.middlewareManager=new a,this.moduleLoader=new h,this.middlewareExecutor=new u,this.events.on("MIDDLEWARE_READY",e=>{this.handleMiddlewareReady(e)})}async emitAsync(e){return this.events.dispatchEvent(e)}setRegistryResolver(e){this.manifestResolver.setRegistryResolver(e)}setPreloadCallback(e){this.manifestResolver.setPreloadCallback(e)}async signalMiddlewareReady(e,t={}){const r=new CustomEvent("MIDDLEWARE_READY",{detail:{name:t.name||e.reg.middleware.name,status:t.status||"ready",share:t.share,cc:e}});await this.emitAsync(r)}async handleMiddlewareReady(e){const{name:t,status:r,cc:s,share:a}=e.detail,i=a||{},{resumes:n}=this.middlewareExecutor.processReadyMiddleware(s.reg.fullKey,i);for(const e of n)await this.middlewareExecutor.callMiddlewares(e.callContexts,async(e,t)=>this.signalMiddlewareReady(e,{share:t}),(e,t,r)=>this.bootstrapCoordinator.registerProviderMode(e,t,r))}async loadFynAppsByName(e,t){const r=this.manifestResolver.preloadCallback;if(r)for(const t of e){const e=await this.manifestResolver.registryResolver(t.name,t.range);r(`${this.manifestResolver.calculateDistBase(e)}fynapp-entry.js`,0)}const s=await this.manifestResolver.buildGraph(e),a=this.manifestResolver.topoBatches(s),i=Math.max(1,Math.min(t?.concurrency??4,8)),n=this.manifestResolver.getAllNodeMeta();for(const e of a){const t=e.map(e=>{const t=n.get(e),r=t.distBase||t.manifestUrl.replace(/\/[^/]*$/,"/");return async()=>{await this.loadFynApp(r)}});let r=0;const s=new Array(Math.min(i,t.length)).fill(0).map(async()=>{for(;r<t.length;){const e=t[r++];await e()}});await Promise.all(s)}}registerMiddleware(e){this.middlewareManager.registerMiddleware(e);const t=this.middlewareManager.exportToRuntime();this.runTime.middlewares=t.middlewares,this.runTime.autoApplyMiddlewares=t.autoApplyMiddlewares}getMiddleware(e,t){return this.middlewareManager.getMiddleware(e,t)}initRunTime(e){return this.runTime={...e},this.middlewareManager.initializeFromRuntime(e),this.runTime}cleanContainerName(e){return e.replace(/[\@\-./]/g,"_").replace(/^_*/,"")}async loadFynAppBasics(e){return this.moduleLoader.loadFynAppBasics(e,this.runTime.appsLoaded,e=>this.registerMiddleware(e))}validateFynUnit(e,t){if("function"==typeof e)return{execute:e};if(e&&"function"==typeof e.execute)return e;throw new Error(`${t}: main export must be a function or have an execute method. Got: ${typeof e}${e?` with keys: ${Object.keys(e).join(", ")}`:""}`)}async bootstrapFynApp(e){this.bootstrapCoordinator.canBootstrap(e)||await this.bootstrapCoordinator.deferBootstrap(e),this.bootstrapCoordinator.acquireBootstrapLock(e.name);try{for(const t of Object.keys(e.entry.container.$E))t.startsWith("./middleware")&&await this.moduleLoader.loadExposeModule(e,t,!0,e=>this.registerMiddleware(e));const t=e.exposes["./main"]?.main;if(t){const r=this.validateFynUnit(t,e.name),s=await this.middlewareExecutor.applyAutoScopeMiddlewares(e,r,this,this.middlewareManager.getAutoApplyMiddlewares(),()=>this.moduleLoader.createFynUnitRuntime(e),async(e,t)=>this.signalMiddlewareReady(e,{share:t}));s.length>0&&console.warn(`‚ö†Ô∏è ${s.length} middleware error(s) during bootstrap of ${e.name}:`,s.map(e=>e.toDetailedString())),r.__middlewareMeta?await this.middlewareExecutor.useMiddlewareOnFynUnit(r,e,this,()=>this.moduleLoader.createFynUnitRuntime(e),(e,t)=>this.getMiddleware(e,t),async(e,t)=>{await this.moduleLoader.loadMiddlewareFromDependency(e,t,this.runTime.appsLoaded,e=>this.registerMiddleware(e))},this.middlewareManager.getAutoApplyMiddlewares()):await this.moduleLoader.invokeFynUnit(r,e,this.middlewareManager.getAutoApplyMiddlewares())}await this.emitAsync(new CustomEvent("FYNAPP_BOOTSTRAPPED",{detail:{name:e.name,version:e.version}}))}catch(t){console.error(`‚ùå Bootstrap failed for ${e.name}:`,t),await this.emitAsync(new CustomEvent("FYNAPP_BOOTSTRAP_FAILED",{detail:{name:e.name,version:e.version,error:t}})),this.bootstrapCoordinator.releaseBootstrapLock()}}buildFynAppUrl(e,t="fynapp-entry.js"){return function(e,t){const r=t.startsWith("/")||e.endsWith("/")?"":"/";return`${e}${r}${t}`}(e,t)}}!function(e){e.CRITICAL="critical",e.IMPORTANT="important",e.DEFERRED="deferred",e.NONE="none"}(n||(n={}));class m extends f{constructor(){super(...arguments),this.preloadStrategy={depth:1,priority:"static",priorityByDepth:{0:n.CRITICAL,1:n.IMPORTANT,2:n.DEFERRED},disabled:!1}}resolvePreloadStrategy(e){return e?.preload?"number"==typeof e.preload?{...this.preloadStrategy,depth:e.preload}:{depth:e.preload.depth??this.preloadStrategy.depth,priority:e.preload.priority??this.preloadStrategy.priority,priorityByDepth:e.preload.priorityByDepth??this.preloadStrategy.priorityByDepth,disabled:e.preload.disabled??this.preloadStrategy.disabled}:this.preloadStrategy}injectPreloadLink(e){if("undefined"==typeof document||!document.head)return;const t=document.createElement("link");t.rel="modulepreload",t.href=e,t.as="script",document.head.appendChild(t)}async loadFynAppsByName(e,t){const r=this.resolvePreloadStrategy(t),s=this.preloadStrategy;this.preloadStrategy=r;try{await super.loadFynAppsByName(e,t)}finally{this.preloadStrategy=s}}async loadFynApp(e,t){const r=globalThis.Federation;if(!r)throw new Error("Federation.js is not loaded.");try{t=t||e;const s=this.buildFynAppUrl(e),a=await r.import(s),i=await this.loadFynAppBasics(a);return await this.bootstrapFynApp(i),i}catch(t){throw console.error(`Failed to load remote fynapp from ${e}:`,t),t}}}globalThis.fynMeshKernel=function(){const e=new m;return e.initRunTime({appsLoaded:{},middlewares:{}}),e.setRegistryResolver(async(e,t)=>({name:e,version:"0.0.0",manifestUrl:`/${e}/dist/fynapp.manifest.json`,distBase:`/${e}/dist/`})),e.setPreloadCallback((t,r)=>{const s=e.preloadStrategy;s.disabled||r>s.depth||e.injectPreloadLink(t)}),e}()}();
//# sourceMappingURL=fynmesh-browser-kernel.min.js.map
