!function(){"use strict";class e extends EventTarget{constructor(){super()}on(e,t,r){this.addEventListener(e,t,r)}once(e,t,r){const n=r=>(this.removeEventListener(e,n),function(e){return"function"==typeof e}(t)?t(r):t.handleEvent(r));this.addEventListener(e,n,r)}}const t={regKey:""};class r{constructor(){this.version="1.0.0",this.shareScopeName="fynmesh",this.deferInvoke=[],this.middlewareReady=new Map,this.bootstrappingApp=null,this.deferredBootstraps=[],this.fynAppBootstrapStatus=new Map,this.fynAppProviderModes=new Map,this.events=new e,this.runTime={appsLoaded:{},middlewares:{}},this.events.on("MIDDLEWARE_READY",e=>{this.handleMiddlewareReady(e)}),this.events.on("FYNAPP_BOOTSTRAPPED",e=>{this.handleFynAppBootstrapped(e)})}async emitAsync(e){return this.events.dispatchEvent(e)}async signalMiddlewareReady(e,t={}){const r=new CustomEvent("MIDDLEWARE_READY",{detail:{name:t.name||e.reg.middleware.name,status:t.status||"ready",share:t.share,cc:e}});await this.emitAsync(r)}async handleMiddlewareReady(e){const{name:t,status:r,cc:n,share:i}=e.detail,o=i||{};this.middlewareReady.set(n.reg.fullKey,o);const s=[];for(let e=0;e<this.deferInvoke.length;e++){const{callContexts:t}=this.deferInvoke[e];let r=0;for(const e of t)e.reg.fullKey===n.reg.fullKey&&(e.runtime.share=o,e.status="ready"),"ready"===e.status&&r++;r===t.length&&(s.push(this.deferInvoke[e]),this.deferInvoke[e]=null)}if(s.length>0){this.deferInvoke=this.deferInvoke.filter(Boolean);for(const e of s)await this.callMiddlewares(e.callContexts)}console.debug(`âœ… Middleware ${t} status: ${r} regKey: ${n.reg.regKey} now: ${Date.now()}`)}async handleFynAppBootstrapped(e){const{name:t}=e.detail;console.debug(`âœ… FynApp ${t} bootstrap complete, checking deferred bootstraps`),this.fynAppBootstrapStatus.set(t,"bootstrapped"),this.bootstrappingApp=null;let r=-1;for(let e=0;e<this.deferredBootstraps.length;e++){const t=this.deferredBootstraps[e];if(this.areBootstrapDependenciesSatisfied(t.fynApp)){r=e;break}}if(r>=0){const e=this.deferredBootstraps.splice(r,1)[0];console.debug(`ðŸ”„ Resuming deferred bootstrap for ${e.fynApp.name} (dependencies satisfied)`),e.resolve()}else this.deferredBootstraps.length>0&&console.debug(`â¸ï¸ ${this.deferredBootstraps.length} deferred bootstrap(s) still waiting for dependencies`)}areBootstrapDependenciesSatisfied(e){const t=this.fynAppProviderModes.get(e.name);if(!t)return!0;for(const[r,n]of t.entries())if("consumer"===n){const t=this.findProviderForMiddleware(r,e.name);if(t&&!this.fynAppBootstrapStatus.has(t))return console.debug(`â³ ${e.name} waiting for provider ${t} to bootstrap (middleware: ${r})`),!1}return!0}findProviderForMiddleware(e,t){for(const[r,n]of this.fynAppProviderModes.entries()){if(r===t)continue;if("provider"===n.get(e))return r}return null}registerMiddleware(e){const{regKey:t,hostFynApp:r}=e;console.log(`ðŸ”§ Registering middleware: ${t}, autoApplyScope:`,e.middleware.autoApplyScope);const n=this.runTime.middlewares[t]||Object.create(null);if(n[r.version])return void console.debug(`âš ï¸ Middleware already registered: ${t}@${r.version} - skipping duplicate registration`);n[r.version]=e,n.default||(n.default=e),this.runTime.middlewares[t]=n;const i=e.middleware.autoApplyScope||[];i.length>0?(this.runTime.autoApplyMiddlewares||(this.runTime.autoApplyMiddlewares={fynapp:[],middleware:[]}),(i.includes("all")||i.includes("fynapp"))&&this.runTime.autoApplyMiddlewares.fynapp.push(e),(i.includes("all")||i.includes("middleware"))&&this.runTime.autoApplyMiddlewares.middleware.push(e),console.debug(`ðŸŽ¯ Registered auto-apply middleware for [${i.join(", ")}]: ${t}@${r.version}`)):console.debug(`âœ… Registered explicit-use middleware: ${t}@${r.version}`)}getMiddleware(e,r){if(r){const t=`${r}::${e}`,n=this.runTime.middlewares[t];if(n){const e=n.default;if(e)return e}}for(const[t,r]of Object.entries(this.runTime.middlewares))if(t.endsWith(`::${e}`)){const e=r.default;if(e)return e}return t}initRunTime(e){return this.runTime={...e},this.runTime}cleanContainerName(e){return e.replace(/[\@\-./]/g,"_").replace(/^_*/,"")}async loadExposeModule(e,t,r){const n=e.entry.container;if(n?.$E[t]){if(n?.$E[t]){const n=(await e.entry.get(t))(),i=[];if(r){for(const[r,o]of Object.entries(n))if(r.startsWith("__middleware__")){const n=o,s=n.name,a={regKey:`${e.name}::${s}`,fullKey:`${e.name}@${e.version}::${s}`,hostFynApp:e,exposeName:t,exportName:r,middleware:n};this.registerMiddleware(a),i.push(r)}return console.debug(`âœ… Expose module '${t}' loaded for`,e.name,e.version,i.length>0?"middlewares registered:":"",i.join(", ")),e.exposes[t]=n,n.__name&&(e.exposes[n.__name]=n),n}}}else console.debug(`âŒ No expose module '${t}' found for`,e.name,e.version)}async loadFynAppBasics(e){const t=e.container;console.debug("ðŸš€ Initializing FynApp entry",t.name,t.version),e.init(),console.debug("ðŸš€ Loading FynApp basics for",t.name,t.version);const r={name:t.name,version:t.version||"1.0.0",packageName:t.name,entry:e,middlewareContext:new Map,exposes:{}};if(t&&t.$E["./config"]){const t=await e.get("./config");r.config=t()}return e.setup&&(console.debug("ðŸš€ Invoking entry.setup for",r.name,r.version),await e.setup()),await this.loadExposeModule(r,"./main",!0),console.debug("âœ… FynApp basics loaded for",r.name,r.version),this.runTime.appsLoaded[r.name]=r,r}createFynModuleRuntime(e){return{fynApp:e,middlewareContext:new Map}}async invokeFynModule(e,t){const r=this.createFynModuleRuntime(t),n=this.findExecutionOverride(t,e);if(n){console.debug(`ðŸŽ­ Middleware ${n.middleware.name} is overriding execution for ${t.name}`);const i={meta:{info:{name:n.middleware.name,provider:n.hostFynApp.name,version:n.hostFynApp.version},config:{}},fynMod:e,fynApp:t,reg:n,runtime:r,kernel:this,status:"ready"};if(n.middleware.overrideInitialize&&e.initialize){console.debug(`ðŸŽ­ Middleware overriding initialize for ${t.name}`);const e=await n.middleware.overrideInitialize(i);console.debug("ðŸŽ­ Initialize result:",e)}return void(n.middleware.overrideExecute&&"function"==typeof e.execute&&(console.debug(`ðŸŽ­ Middleware overriding execute for ${t.name}`),await n.middleware.overrideExecute(i)))}if(e.initialize){console.debug("ðŸš€ Invoking module.initialize for",t.name,t.version);const n=await e.initialize(r);console.debug("ðŸš€ Initialize result:",n)}if(e.execute){console.debug("ðŸš€ Invoking module.execute for",t.name,t.version);const n=await e.execute(r);n&&console.debug("ðŸ“¦ FynModule returned typed result:",n.type,n.metadata)}}findExecutionOverride(e,t){const r=this.runTime.autoApplyMiddlewares;if(!r)return null;const n=Object.keys(e.exposes).some(e=>e.startsWith("./middleware"))?r.middleware:r.fynapp;for(const r of n)if(r.middleware.canOverrideExecution?.(e,t))return r;return null}checkSingleMiddlewareReady(e){return!!this.middlewareReady.has(e.reg.fullKey)&&(e.runtime.share=this.middlewareReady.get(e.reg.fullKey),e.status="ready",!0)}checkMiddlewareReady(e){let t="ready";for(const r of e)this.checkSingleMiddlewareReady(r)||(t="defer");return t}checkDeferCalls(e,t){if("defer"===e){if("ready"===this.checkMiddlewareReady(t))return"retry";const e=t.map(e=>e.reg.fullKey).sort().join("|");return this.deferInvoke.some(t=>t.callContexts.map(e=>e.reg.fullKey).sort().join("|")===e)||this.deferInvoke.push({callContexts:t}),"defer"}return"ready"}async callMiddlewares(e,t=0){if(t>1)throw console.error("ðŸš¨ Middleware setup failed after 2 tries",e),new Error("Middleware setup failed after 2 tries");this.checkMiddlewareReady(e);let r="ready";for(const t of e){const{fynApp:e,reg:n}=t,i=n.middleware;if(this.checkSingleMiddlewareReady(t),i.setup){console.debug("ðŸš€ Invoking middleware",n.regKey,"setup for",e.name,e.version);const o=await i.setup(t);"ready"!==o?.status||this.middlewareReady.has(t.reg.fullKey)||await this.signalMiddlewareReady(t,{share:o?.share}),"defer"===o?.status&&(r="defer")}}if(r=this.checkDeferCalls(r,e),"defer"===r)return r;if("retry"===r)return await this.callMiddlewares(e,t+1);const n=e[0].fynMod,i=e[0].fynApp,o=e[0].runtime;if(n.initialize){console.debug("ðŸš€ Invoking user.initialize for",i.name,i.version);const s=await n.initialize(o);if(s?.mode){this.fynAppProviderModes.has(i.name)||this.fynAppProviderModes.set(i.name,new Map);const t=this.fynAppProviderModes.get(i.name);for(const r of e)t.set(r.reg.middleware.name,s.mode);console.debug(`ðŸ“ ${i.name} registered as ${s.mode} for middleware(s)`)}if(r=this.checkDeferCalls(s?.status,e),"defer"===r)return r;if("retry"===r)return await this.callMiddlewares(e,t+1)}for(const t of e){const{reg:e}=t,r=e.middleware;r.apply&&(console.debug("ðŸš€ Invoking middleware",e.regKey,"apply for",i.name,i.version),await r.apply(t))}return n.execute&&(console.debug("ðŸš€ Invoking user.execute for",i.name,i.version),await n.execute(o)),"ready"}async useMiddlewareOnFynModule(e,t){if(!e.__middlewareMeta)return"";const r=this.createFynModuleRuntime(t),n=e.__middlewareMeta.map(n=>{const i=n.info,o=this.getMiddleware(i.name,i.provider);return""===o.regKey?(console.debug("âŒ No middleware found for",i.name,i.provider),{}):{meta:n,fynMod:e,fynApp:t,reg:o,kernel:this,runtime:r,status:""}}).filter(e=>void 0!==e.meta);return this.callMiddlewares(n)}async applyAutoScopeMiddlewares(e,t){console.log(`ðŸŽ¯ Auto-apply check for ${e.name}: autoApplyMiddlewares exists?`,!!this.runTime.autoApplyMiddlewares);const r=this.runTime.autoApplyMiddlewares;if(!r)return void console.log(`â­ï¸ No auto-apply middlewares registered yet for ${e.name}`);const n=Object.keys(e.exposes).some(e=>e.startsWith("./middleware"))?r.middleware:r.fynapp;for(const r of n){if(r.middleware.shouldApply)try{if(!r.middleware.shouldApply(e)){console.debug(`â­ï¸ Skipping middleware ${r.regKey} for ${e.name} (filtered out)`);continue}}catch(e){console.error(`âŒ Error in shouldApply for ${r.regKey}:`,e);continue}console.debug(`ðŸ”„ Auto-applying ${r.middleware.autoApplyScope} middleware ${r.regKey} to ${e.name}`);const n={meta:{info:{name:r.middleware.name,provider:r.hostFynApp.name,version:r.hostFynApp.version},config:{}},fynMod:t||{async execute(){}},fynApp:e,reg:r,runtime:this.createFynModuleRuntime(e),kernel:this,status:"ready"};try{if(r.middleware.setup){const e=await r.middleware.setup(n);"ready"===e?.status&&await this.signalMiddlewareReady(n,{share:e.share})}r.middleware.apply&&await r.middleware.apply(n)}catch(t){console.error(`âŒ Failed to apply auto-scope middleware ${r.regKey} to ${e.name}:`,t)}}}async bootstrapFynApp(e){if(null!==this.bootstrappingApp||!this.areBootstrapDependenciesSatisfied(e)){const t=null!==this.bootstrappingApp?`${this.bootstrappingApp} is currently bootstrapping`:"waiting for provider dependencies";console.debug(`â¸ï¸ Deferring bootstrap of ${e.name} (${t})`),await new Promise(t=>{this.deferredBootstraps.push({fynApp:e,resolve:t})}),console.debug(`â–¶ï¸ Resuming bootstrap of ${e.name}`)}this.bootstrappingApp=e.name,console.debug(`ðŸ”’ ${e.name} acquired bootstrap lock`);try{for(const t of Object.keys(e.entry.container.$E))t.startsWith("./middleware")&&await this.loadExposeModule(e,t,!0);const t=e.exposes["./main"]?.main;t&&(console.debug("ðŸš€ Bootstrapping FynApp",e.name,e.version),await this.applyAutoScopeMiddlewares(e,t),"function"==typeof t?await t(this.createFynModuleRuntime(e)):t.__middlewareMeta?await this.useMiddlewareOnFynModule(t,e):await this.invokeFynModule(t,e)),console.debug("âœ… FynApp bootstrapped",e.name,e.version),await this.emitAsync(new CustomEvent("FYNAPP_BOOTSTRAPPED",{detail:{name:e.name,version:e.version}}))}catch(t){if(console.error(`âŒ Bootstrap failed for ${e.name}:`,t),this.bootstrappingApp=null,this.deferredBootstraps.length>0){const e=this.deferredBootstraps.shift();e&&e.resolve()}throw t}}buildFynAppUrl(e,t="fynapp-entry.js"){return function(e,t){const r=t.startsWith("/")||e.endsWith("/")?"":"/";return`${e}${r}${t}`}(e,t)}}class n extends r{async loadFynApp(e,t){const r=globalThis.Federation;if(!r)throw new Error("Federation.js is not loaded.");try{t=t||e;const n=this.buildFynAppUrl(e);console.debug("ðŸš€ Loading FynApp from",n);const i=await r.import(n);console.debug("ðŸš€ FynApp entry loaded",i);const o=await this.loadFynAppBasics(i);await this.bootstrapFynApp(o)}catch(t){throw console.error(`Failed to load remote fynapp from ${e}:`,t),t}}}globalThis.fynMeshKernel=function(){const e=new n;return e.initRunTime({appsLoaded:{},middlewares:{}}),e}()}();
//# sourceMappingURL=fynmesh-browser-kernel.min.js.map
