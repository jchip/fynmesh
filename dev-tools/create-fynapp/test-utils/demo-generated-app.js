const fs = require("fs");
const path = require("path");

function demoGeneratedApp() {
  console.log("ğŸ¯ Demo: Complete FynApp Generated by Smart Detection\n");

  const appDir = path.join(__dirname, "../test/demo/test-fynapp");

  if (!fs.existsSync(appDir)) {
    console.log("âŒ Generated app not found. Run `npm run jest-test` first.");
    return;
  }

  console.log("âœ… Generated FynApp found at:", appDir);
  console.log("\nğŸ“ Complete App Structure:");

  function showTree(dir, prefix = "", isLast = true) {
    const items = fs.readdirSync(dir).sort();

    items.forEach((item, index) => {
      const itemPath = path.join(dir, item);
      const isDirectory = fs.statSync(itemPath).isDirectory();
      const isLastItem = index === items.length - 1;
      const connector = isLastItem ? "â””â”€â”€ " : "â”œâ”€â”€ ";
      const icon = isDirectory ? "ğŸ“" : "ğŸ“„";

      console.log(`${prefix}${connector}${icon} ${item}`);

      if (isDirectory && item !== "node_modules") {
        const newPrefix = prefix + (isLastItem ? "    " : "â”‚   ");
        showTree(itemPath, newPrefix, isLastItem);
      }
    });
  }

  showTree(appDir);

  console.log("\nğŸ” Smart Detection Results:");

  // Show package.json React version
  const packageJson = JSON.parse(fs.readFileSync(path.join(appDir, "package.json"), "utf8"));
  console.log(`ğŸ“¦ React Version Detected: ${packageJson.dependencies["esm-react"]}`);

  // Show rollup config exposes
  const rollupConfig = fs.readFileSync(path.join(appDir, "rollup.config.mjs"), "utf8");
  const exposesMatch = rollupConfig.match(/exposes: \{([^}]+)\}/s);
  if (exposesMatch) {
    console.log("ğŸ¯ Auto-detected Exposes:");
    const exposesContent = exposesMatch[1];
    const exposeLines = exposesContent.split("\n").filter((line) => line.includes('"./'));
    exposeLines.forEach((line) => {
      const trimmed = line.trim().replace(/,$/, "");
      if (trimmed) {
        console.log(`  ${trimmed}`);
      }
    });
  }

  console.log("\nğŸš€ Generated Features:");
  console.log("  âœ… Complete React 18 setup with TypeScript");
  console.log("  âœ… Module Federation configuration");
  console.log("  âœ… Smart exposes detection (main, App, config, components, utils)");
  console.log("  âœ… Semver-preserved React version (^18.3.0)");
  console.log("  âœ… Modern Modal component with configurable overlay");
  console.log("  âœ… Reusable Button component with variants");
  console.log("  âœ… Utility functions and API client");
  console.log("  âœ… Proper barrel exports");
  console.log("  âœ… Development and build scripts");
  console.log("  âœ… SystemJS integration for microfrontend loading");

  console.log("\nğŸ“‹ Component Highlights:");

  // Show Modal component features
  const modalContent = fs.readFileSync(path.join(appDir, "src/components/Modal.tsx"), "utf8");
  if (modalContent.includes("overlayOpacity") && modalContent.includes("overlayBlur")) {
    console.log("  ğŸ­ Modal: Configurable overlay opacity and blur");
  }

  // Show Button component features
  const buttonContent = fs.readFileSync(path.join(appDir, "src/components/Button.tsx"), "utf8");
  if (buttonContent.includes("variant")) {
    console.log("  ğŸ”˜ Button: Primary/secondary variants with styled themes");
  }

  console.log("\nğŸ› ï¸  Ready to Use Commands:");
  console.log("  ğŸ“ cd test/demo/test-fynapp");
  console.log("  ğŸ“¦ npm install");
  console.log("  ğŸ”¨ npm run build");
  console.log("  ğŸš€ npm run dev");
  console.log("  ğŸŒ npm run serve");

  console.log("\nğŸ‰ This demonstrates the complete end-to-end capability of:");
  console.log("  â€¢ Smart React version detection from package.json");
  console.log("  â€¢ Intelligent project structure scanning for exposes");
  console.log("  â€¢ Complete FynApp generation with modern best practices");
  console.log("  â€¢ Ready-to-use microfrontend with federation setup");

  console.log("\nâœ¨ The generated app is production-ready and follows FynMesh patterns!");
}

demoGeneratedApp();
